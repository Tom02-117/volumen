<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagar Clase Individual</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="cliente/panel_styles.css">
    <style>
        .container { max-width: 600px; margin: 2rem auto; }
        .summary, .login-form, .paypal-container {
            background-color: white; padding: 2rem; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.06); margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="summary">
            <h2><i class="bi bi-ticket-perforated"></i> Pagar Clase Individual</h2>
            <p id="clase-info">Cargando...</p>
            <hr>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <strong>Total a Pagar (USD):</strong>
                <span style="font-size: 2rem; font-weight: 700;">$5.00</span>
            </div>
        </div>

        <div id="login-section" class="login-form">
            <h4>Paso 1: Inicia Sesión para Continuar</h4>
            <p>Necesitamos vincular esta compra a tu cuenta.</p>
            <form id="login-form-clase" class="mt-3">
                <div class="mb-3">
                    <label>Tipo de Documento</label>
                    <select name="tipo_documento" class="form-input" required>
                        <option value="CC">Cédula de Ciudadanía</option>
                        <option value="CE">Cédula de Extranjería</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label>Número de Documento</label>
                    <input type="text" name="numero_documento" class="form-input" required>
                </div>
                <div class="mb-3">
                    <label>Contraseña</label>
                    <input type="password" name="password" class="form-input" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%;">Verificar Cuenta</button>
            </form>
            <p class="mt-3 text-center">¿No tienes cuenta? <a href="crearcuenta.html">Regístrate aquí</a>.</p>
        </div>

        <div id="payment-section" class="paypal-container" style="display: none;">
            <h4>Paso 2: Realiza el Pago</h4>
            <div id="paypal-button-container"></div>
        </div>
        <a href="asistencia.html" style="display: block; text-align: center;">Cancelar</a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=AbwVdvNuQxFW2CYwIv-NHpMRWapxOCutxQTXR5-3oJ2qDOUArY-UG0vQ2ZXVsl6-XymvzWYDxHIVofgk&currency=USD"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const clase = params.get('clase') || 'N/A';
        const dia = params.get('dia') || 'N/A';
        const hora = params.get('hora') || 'N/A';
        const precioClase = '5.00';

        document.getElementById('clase-info').innerText = `Clase: ${clase}\nDía: ${dia}\nHora: ${hora}`;

        const loginForm = document.getElementById('login-form-clase');
        const loginSection = document.getElementById('login-section');
        const paymentSection = document.getElementById('payment-section');

        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            Swal.fire({
                title: "Cuenta Verificada",
                text: "Ahora puedes proceder con el pago.",
                icon: "success",
                timer: 2000,
                showConfirmButton: false
            });
            loginSection.style.display = 'none';
            paymentSection.style.display = 'block';
        });

        paypal.Buttons({
            createOrder: function(data, actions) {
                return actions.order.create({
                    purchase_units: [{
                        description: `Clase individual: ${clase} (${dia} - ${hora})`,
                        amount: { value: precioClase }
                    }]
                });
            },
            onApprove: function(data, actions) {
                return actions.order.capture().then(function(details) {
                    const formData = new FormData(loginForm);
                    const postData = {
                        orderID: data.orderID,
                        clase: clase, dia: dia, hora: hora,
                        tipo_documento: formData.get('tipo_documento'),
                        numero_documento: formData.get('numero_documento'),
                        password: formData.get('password')
                    };

                    fetch('../backend/asistencia/procesar_pago_clase.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(postData)
                    })
                    .then(response => response.json())
                    .then(serverData => {
                        if (serverData.status === 'success') {
                            window.location.href = 'pago_exitoso.html?clase=' + encodeURIComponent(clase);
                        } else {
                            Swal.fire("Error", serverData.message, "error");
                        }
                    });
                });
            }
        }).render('#paypal-button-container');
    </script>
</body>
</html>